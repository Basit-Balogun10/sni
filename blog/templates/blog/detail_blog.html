{% extends 'base.html' %}
{% load blog_extras %}


{% block content %}


<style type="text/css">
	#login-message {
		display: none;
	}

	html,
	body {
		background: linear-gradient(35deg, #002657, #c582eb);
	}

	.grid-container5 {
		display: inline-grid;
		grid-template-columns: 65% 30%;
		grid-column-gap: 3.5rem;
		margin: 5%;
	}

	img.post-img {
		width: 100%;
		height: 40rem;
	}

	.post-content {}

	.post-title {
		font-size: 3rem;
		text-align: center;

	}

	.post-info {
		font-size: 1.5rem;
		color: skyblue;
		font-weight: bold;
		margin-bottom: 10px;
	}

	.post-header {
		margin-bottom: 3rem;
		color: #002657;
		text-align: center;

	}

	.post-text {
		font-size: 1.6rem;
		padding: 5%;
		border: 7px solid #C582EB;
		border-radius: 7px;
		border-left-color: skyblue;
		border-right-color: skyblue;
		border-top-style: double;
		border-bottom-style: double;
		color: antiquewhite;
	}

	.comment-section {
		margin-top: 10rem;
		font-size: 1.6rem;
	}

	textarea.comment-box {
		width: 100%;
	}

	button.submit-comment {
		color: #c582eb;
		padding: 9px;
		border-radius: 7px;
		border: 2px solid #002657;
		transition: background-color, border 1s;
		cursor: pointer;
		text-align: center;
		font-size: 2.3rem;
		margin-top: 10px;
		background: #002657;
	}

	button.submit-comment:hover {
		color: #002657;
		background: #c582eb;
		border: #c582eb;
		padding: 9px;
	}

	span.info-head,
	span.author {
		color: #002657;
	}

	span.category {
		border: 1px solid #002657;
		background: #002657;
		color: #c582eb;
		padding: 0.9rem;
		margin-left: 1.2rem;
		border-radius: 3rem;
	}

	p.post-category {
		margin-top: 4rem;
		margin-bottom: 4rem;
		font-size: 1.8rem;
	}

	.reply {
		margin-left: 5%;
		margin-bottom: 2%;
	}

	#reply-div {
		display: none;
	}

	.read-more {
		display: inline-grid;
		grid-template-rows: 33.3% 33.3% 33.3%;
		margin-top: 35px
	}


	.head {
		display: flex;
		justify-content: center;
		margin-bottom: 30px;
	}

	form {
		text-align: center;
	}

	button.text {
		cursor: pointer;
		font-size: 1.8rem;
		padding-top: 1.5rem;
		border: 0.1rem solid #002657;
		padding: 0.9rem;
		text-align: center;
		border-radius: 3rem;
		background: #002657;
		color: #c582eb;
		font-weight: bold;
		font-family: apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif;
	}

	button.text span {
		color: skyblue;
	}

	button.text:hover {
		background: #c582eb;
		color: #002657;
		border: 0.1rem solid #c582eb;
	}

	.read-more>div {
		margin-top: 2rem;
	}

	.post-container {
		display: inline-grid;
		grid-template-columns: 40% 60%;
		border-top: 2px solid #002657;
		margin-top: 2px;
		padding-top: 2px;
		grid-column-gap: 5px;
	}

	.post-image {
		width: 100%;
		height: 100px;
	}

	.post-ttl {
		font-size: 1.7rem;
		color: white;
	}

	p.post-time {
		font-size: 1.2rem;
		color: #002657;
		font-weight: bold;
	}

	p.post-author {
		font-size: 1.2rem;
		color: #91d9f7;
	}

	button.see-more {
		cursor: pointer;
		font-size: 1.7rem;
		margin-left: 60%;
		padding: 5px;
		color: white;
		background: skyblue;
		border-radius: 5px;
		border: 1px solid skyblue;
		font-family: apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif;
	}
</style>

<div class="container">
	{% comment %} <div class="row">

		<!-- Blog Post -->
		<div class="card m-auto">
			<img class="card-img-top" src="{{blog_post.image.url}}">
			<div class="card-body mt-2 mb-2">
				<h2 class="card-title">{{blog_post.title}}</h2>
				<p class="card-text">{{blog_post.body|safe}}</p>
				{% if blog_post.author == request.user %}
				<a href="{% url 'blog:edit' blog_post.category %}" class="btn btn-primary">Update</a>
				{% endif %}
			</div>
			<div class="card-footer text-muted">
				Updated on {{blog_post.date_updated}} by {{blog_post.author}}
			</div>
		</div>
	</div> {% endcomment %}


	{% concat_all blog_post.date_published.hour|stringformat:"i" '-' blog_post.date_published.minute|stringformat:"i" '-' blog_post.date_published.second|stringformat:"i" '-' blog_post.date_published.microsecond|stringformat:"i"  as blog_time_published %}
	<div class="grid-container5">
		<div class="main-article">
			<div class="post-header">
				<div class="post-info">
					{% if blog_post.date_published != blog_post.date_updated %}
					<p><span class="info-head">Date Published: </span>{{blog_post.date_published|myfunc|upper}} <span
							class="published author">by
							{{blog_post.author}}</span></p>
					<br>
					<p><span class="info-head">Date Updated: </span>{{blog_post.date_updated|myfunc|upper}} <span
							class="updated author">by
							{{blog_post.author}}</span></p>
					{% else %}
					<p><span class="info-head">Date Published: </span>{{blog_post.date_published|myfunc|upper}} <span
							class="published author">by
							{{blog_post.author}}</span></p>
					{% endif %}

					<p class="post-category"><span class="info-head">Category: </span><span
							class="category">{{ blog_post.category|upper }}</span></p>
					<a class="likebutton btn btn-{{like_color}} btn-lg" id="like{{ blog_post.id }}" href="#"
						data-catid="{{ blog_post.id }}" data-value="{{blog_post.num_likes}}">{{blog_post.num_likes}} <i
							class="fa fa-thumbs-up"></i></a>
					<a class="dislikebutton btn btn-{{dislike_color}} btn-lg" id="dislike{{ blog_post.id }}" href="#"
						data-catid="{{ blog_post.id }}"
						data-value="{{blog_post.num_dislikes}}">{{blog_post.num_dislikes}} <i
							class="fa fa-thumbs-down"></i></a>
					<h3 id="login-message" style="display: none;">Sorry, you have to be logged in to like or dislike
						posts</h3>
				</div>
				<h2 class="post-title">{{blog_post.title}}</h2>
			</div>
			<div class="post-content">
				<img class="post-img" src="{{blog_post.image.url}}">
				<p class="post-text">{{blog_post.body|safe}}</p>
				{% if blog_post.author == request.user %}
				<a href="{% url 'blog:edit' blog_post.category %}" class="btn btn-primary">Update</a>
				{% endif %}
			</div>

			<div class="container">
				<div class="row">
					<div class="col-md-8 card mb-4  mt-3 ">
						<div class="card-body">
							<!-- comments -->
							<h2 id="comments-count" data-value={{comments.count}}>{{ comments.count }} comments</h2>

							<div id="comment-container">
								{% for comment in comments %}
								<div class="comments" style="padding: 10px;">
									<p class="font-weight-bold">
										{{ comment.commenter }}
										<span class=" text-muted font-weight-normal">
											{{ comment.created_on }}
										</span>
									</p>
									{{ comment.body | linebreaks }}
									<a href="javascript:void(0)" class="reply-button" id="reply-button"
										onclick="replyComment(this)" title="Reply to this comment">Reply</a>
									<div class="reply-div" id="reply-div">
										<form method="post" style="margin-top: 1.3em;">
											{% csrf_token %}
											{{ reply_form.as_p }}
											<input type="hidden" name="parent_id" value="{{comment.id}}">
											<button type="submit" class="btn btn-primary btn-lg reply-button"
												name="action" value="to_reply">Submit</button>
										</form>
									</div>
									{% for reply in comment.replies.all %}
									<div class="reply">
										<p class="font-weight-bold">
											{{ reply.replier }}
											<span class="text-muted font-weight-normal">
												{{ reply.created_on }}
											</span>
										</p>

										{{ reply.body | linebreaks }}
									</div>
									{% endfor %}
								</div>
								{% endfor %}
							</div>
						</div>
					</div>
					<div class="col-md-8 card mb-4  mt-3 ">
						<div class="card-body">
							{% if new_comment %}
							<div class="alert alert-success" role="alert">
								Your comment is awaiting moderation
							</div>
							{% else %}
							{% concat_all post.date_published.hour|stringformat:"i" '-' post.date_published.minute|stringformat:"i" '-' post.date_published.second|stringformat:"i" '-' post.date_published.microsecond|stringformat:"i"  as blog_time_published %}
							<h3>Leave a comment</h3>
							<form method="post" style="margin-top: 1.3em;" id="comment-form">
								{% csrf_token %}
								{{ comment_form.as_p }}
								<a type="submit" class="btn btn-primary btn-lg comment-button" name="action"
									value="to_comment">Submit</a>
							</form>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="read-more">
			<div class="trending-posts">
				<div class="head">
					<form action="{% url 'sni_app:home' %}" method="get">
						<button class="text" type="submit" name="posted-since" id="trending-category"
							value="{{blog_post.date_updated}}">
							TRENDING POSTS</button>
					</form>
				</div>
				{% for post in trending_posts %}
				{% concat_all post.date_published.hour|stringformat:"i" '-' post.date_published.minute|stringformat:"i" '-' post.date_published.second|stringformat:"i" '-' post.date_published.microsecond|stringformat:"i"  as blog_time_published %}
				<div class="post-container" onmouseover="activateDiv(this)" onmouseout="deactivateDiv(this)">

					<div class="post-image-container">
						<a
							href="{% url 'blog:detail' post.category post.date_published.year post.date_published.month post.date_published.day blog_time_published post.id post.title|slugify %}"><img
								class="post-image" src="{{post.image.url}}"></a>
					</div>

					<div class="post-summary-container">
						<a
							href="{% url 'blog:detail' post.category post.date_published.year post.date_published.month post.date_published.day blog_time_published post.id post.title|slugify %}">
							<p class="post-ttl">{{post.title}}</p>
							<p class="post-time">{{post.date_updated|myfunc}}</p>
							<p class="post-author">By {{post.author}}</p>
						</a>
					</div>
				</div>
				{% endfor %}
				<form action="{% url 'sni_app:home' %}" method="get">
					<button class="see-more" type="submit" name="posted-since" id="seemore-trending"
						value="{{blog_post.date_updated}}">
						See More >>>
					</button>
				</form>
			</div>

			<div class="related-posts">
				<div class="head">
					<form action="{% url 'sni_app:home' %}" method="get">
						<button class="text" type="submit" name="related-to" id="related-category"
							value="{{blog_post.title}}">
							RELATED POSTS</button>
					</form>
				</div>
				{% for post in related_posts %}
				{% concat_all post.date_published.hour|stringformat:"i" '-' post.date_published.minute|stringformat:"i" '-' post.date_published.second|stringformat:"i" '-' post.date_published.microsecond|stringformat:"i"  as blog_time_published %}
				<div class="post-container" onmouseover="activateDiv(this)" onmouseout="deactivateDiv(this)">


					<div class="post-image-container">
						<a
							href="{% url 'blog:detail' post.category post.date_published.year post.date_published.month post.date_published.day blog_time_published post.id post.title|slugify %}"><img
								class="post-image" src="{{post.image.url}}"></a>
					</div>

					<div class="post-summary-container">
						<a
							href="{% url 'blog:detail' post.category post.date_published.year post.date_published.month post.date_published.day blog_time_published post.id post.title|slugify %}">
							<p class="post-ttl">{{post.title}}</p>
							<p class="post-time">{{post.date_updated|myfunc}}</p>
							<p class="post-author">By {{post.author}}</p>
						</a>
					</div>

				</div>
				{% endfor %}
				<form action="{% url 'sni_app:home' %}" method="get">
					<button class="see-more" type="submit" name="related-to" id="seemore-related"
						value="{{blog_post.title}}">
						See More >>>
					</button>
				</form>
			</div>

			<div class="author-posts">
				<div class="head">
					<form action="{% url 'sni_app:home' %}" method="get">
						<button class="text" type="submit" name="posts-from" id="author-category"
							value="{{blog_post.author}}">MORE
							POSTS FROM
							<span>{{blog_post.author|upper}}</span></button>
					</form>
				</div>
				{% for post in author_posts %}
				{% concat_all post.date_published.hour|stringformat:"i" '-' post.date_published.minute|stringformat:"i" '-' post.date_published.second|stringformat:"i" '-' post.date_published.microsecond|stringformat:"i"  as blog_time_published %}
				<div class="post-container" onmouseover="activateDiv(this)" onmouseout="deactivateDiv(this)">

					<div class="post-image-container">
						<a
							href="{% url 'blog:detail' post.category post.date_published.year post.date_published.month post.date_published.day blog_time_published post.id post.title|slugify %}">
							<img class="post-image" src="{{post.image.url}}"></a>
					</div>

					<div class="post-summary-container">
						<a
							href="{% url 'blog:detail' post.category post.date_published.year post.date_published.month post.date_published.day blog_time_published post.id post.title|slugify %}">
							<p class="post-ttl">{{post.title}}</p>
							<p class="post-time">{{post.date_updated|myfunc}}</p>
							<p class="post-author">By {{post.author}}</p>
						</a>
					</div>
				</div>
				{% endfor %}
				<form action="{% url 'sni_app:home' %}" method="get">
					<button class="see-more" type="submit" name="posts-from" id="seemore-from-author"
						value="{{blog_post.author}}">
						See More >>>
					</button>
				</form>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	$('.likebutton').click(function () {
		if ('{{ request.user.is_authenticated }}' === 'True') {
			var id;
			var likes;
			id = $(this).attr("data-catid");
			likes = $(this).data("value");
			dislikes = $('#dislike' + id).data("value");
			console.log(likes + ' l')
			console.log(dislikes + 'd')
			$.ajax({
				type: "POST",
				url: "",
				data: {
					post_id: id,
					'csrfmiddlewaretoken': '{{ csrf_token }}',
					action: 'to_like'
				},
				success: function (data) {
					if ($('#like' + id).hasClass('btn-primary') & $('#dislike' + id).hasClass(
							'btn-success')) {
						$('#like' + id).removeClass('btn btn-primary btn-lg');
						$('#like' + id).addClass('btn btn-success btn-lg');
						$('#dislike' + id).removeClass('btn btn-success btn-lg');
						$('#dislike' + id).addClass('btn btn-primary btn-lg');

						dislikes = dislikes - 1;
						likes = likes + 1;
						console.log(likes + ',' + dislikes)
						$("#like" + id).data('value', likes)
						$("#dislike" + id).data('value', dislikes)

						$('#dislike' + id).html(
							dislikes + ' <i class="fa fa-thumbs-down"></i>');
						$('#like' + id).html((likes +
							' <i class="fa fa-thumbs-up"></i>'));
					} else if ($('#like' + id).hasClass('btn-success') & $('#dislike' + id).hasClass(
							'btn-primary')) {
						$('#like' + id).removeClass('btn btn-success btn-lg');
						$('#like' + id).addClass('btn btn-primary btn-lg');

						likes = likes - 1;
						console.log(likes + ' l')
						$("#like" + id).data('value', likes)

						$('#like' + id).html(
							likes + ' <i class="fa fa-thumbs-up"></i>');
					} else if ($('#like' + id).hasClass('btn-primary') & $('#dislike' + id).hasClass(
							'btn-primary')) {
						$('#like' + id).removeClass('btn btn-primary btn-lg');
						$('#like' + id).addClass('btn btn-success btn-lg');

						likes = likes + 1;
						console.log(likes + ' l')
						$("#like" + id).data('value', likes)

						$('#like' + id).html(
							likes + ' <i class="fa fa-thumbs-up"></i>');
					}
				}
			})
		} else {
			console.log('NOT AUTHENTICATED')
			document.getElementById("login-message").style.display = "block";
		};
	});
	$('.dislikebutton').click(function () {
		if ('{{ request.user.is_authenticated }}' === 'True') {
			var id;
			var dislikes;
			id = $(this).attr("data-catid");
			dislikes = $(this).data("value");
			likes = $('#like' + id).data("value");
			console.log(dislikes + 'd');
			console.log(likes + ' l')
			$.ajax({
				type: "POST",
				url: "",
				data: {
					post_id: id,
					'csrfmiddlewaretoken': '{{ csrf_token }}',
					action: 'to_dislike'
				},
				success: function (data) {
					if ($('#like' + id).hasClass('btn-primary') & $('#dislike' + id).hasClass(
							'btn-success')) {
						$('#dislike' + id).removeClass('btn btn-success btn-lg');
						$('#dislike' + id).addClass('btn btn-primary btn-lg');

						dislikes = dislikes - 1;
						console.log(dislikes + 'd')
						$("#dislike" + id).data('value', dislikes)

						$('#dislike' + id).html(
							dislikes + ' <i class="fa fa-thumbs-down"></i>');
					} else if ($('#like' + id).hasClass('btn-success') & $('#dislike' + id).hasClass(
							'btn-primary')) {
						$('#like' + id).removeClass('btn btn-success btn-lg');
						$('#like' + id).addClass('btn btn-primary btn-lg');
						$('#dislike' + id).removeClass('btn btn-primary btn-lg');
						$('#dislike' + id).addClass('btn btn-success btn-lg');

						dislikes = dislikes + 1;
						likes = likes - 1;
						console.log(likes + ',' + dislikes)
						$("#like" + id).data('value', likes)
						$("#dislike" + id).data('value', dislikes)

						$('#dislike' + id).html(
							dislikes + ' <i class="fa fa-thumbs-down"></i>');
						$('#like' + id).html((likes +
							' <i class="fa fa-thumbs-up"></i>'));
					} else if ($('#like' + id).hasClass('btn-primary') & $('#dislike' + id).hasClass(
							'btn-primary')) {
						$('#dislike' + id).removeClass('btn btn-primary btn-lg');
						$('#dislike' + id).addClass('btn btn-success btn-lg');

						dislikes = dislikes + 1;
						$("#dislike" + id).data('value', dislikes)

						console.log(dislikes + 'd')
						$('#dislike' + id).html(
							dislikes + ' <i class="fa fa-thumbs-down"></i>');
					}
				}
			})
		} else {
			console.log('NOT AUTHENTICATED')
			document.getElementById("login-message").style.display = "block";
		}
	});

	// $('.comment-button').click(function () {
	// 	if ('{{ request.user.is_authenticated }}' === 'True') {
	// 		var commentsCount, commentContainer;
	// 		commentsCount = document.getElementById('comments-count');
	// 		count = $('#comments-count').data("value");
	// 		commentContainer = document.getElementById('comment-container');
	// 		$.ajax({
	// 			type: "POST",
	// 			url: "",
	// 			data: {
	// 				'csrfmiddlewaretoken': '{{ csrf_token }}',
	// 				action: 'to_comment'
	// 			},
	// 			success: function (data) {
	// 				count += 1;
	// 				console.log('{{request.user}}');
	// 				commentsCount.innerHTML = count + " comments";

	// 				commentContainer.innerHTML +=
	// 					'<div class="comments" style="padding: 10px;"><p class="font-weight-bold">{{ request.user }}<span class=" text-muted font-weight-normal">{{ new_comment.created_on }}</span></p>{{ new_comment.body | linebreaks }}<a href="javascript:void(0)" class="reply-button" id="reply-button" onclick="replyComment(this)" title="Reply to this comment">Reply</a><div class="reply-div" id="reply-div"><form method="post" style="margin-top: 1.3em;">{% csrf_token %}{{ reply_form.as_p }}<input type="hidden" name="parent_id" value="{{new_comment.id}}"><button type="submit" class="btn btn-primary btn-lg reply-button" name="action" value="to_reply">Submit</button></form></div>{% for reply in new_comment.replies.all %}<div class="reply"><p class="font-weight-bold">{{ reply.replier }}<span class="text-muted font-weight-normal">{{ reply.created_on }}</span></p>{{ reply.body | linebreaks }}</div>{% endfor %}</div>';
	// 			}
	// 		})
	// 	}
	// });

	$(document).ready(function() {
		console.log('ready')
    $("#comment-form").submit(function(event) {
       event.preventDefault();
	   console.log('submitted')
	   var commentsCount, commentContainer;
	   form = $("#comment-form");
	   commentsCount = document.getElementById('comments-count');
	   count = $('#comments-count').data("value");
	   commentContainer = document.getElementById('comment-container');
       $.ajax({ data: $(this).serialize(), 
                type: "POST", 
                url: "",
				'csrfmiddlewaretoken': '{{ csrf_token }}',
				action: 'to_comment',
                success: function(response) {
                     console.log(response);
                     if ('{{ request.user.is_authenticated }}' === 'True') {
						count += 1;
						console.log('{{request.user}}');
						commentsCount.innerHTML = count + " comments";

						commentContainer.innerHTML +='<div class="comments" style="padding: 10px;"><p class="font-weight-bold">{{ request.user }}<span class=" text-muted font-weight-normal">{{ new_comment.created_on }}</span></p>{{ new_comment.body | linebreaks }}<a href="javascript:void(0)" class="reply-button" id="reply-button" onclick="replyComment(this)" title="Reply to this comment">Reply</a><div class="reply-div" id="reply-div"><form method="post" style="margin-top: 1.3em;">{% csrf_token %}{{ reply_form.as_p }}<input type="hidden" name="parent_id" value="{{new_comment.id}}"><button type="submit" class="btn btn-primary btn-lg reply-button" name="action" value="to_reply">Submit</button></form></div>{% for reply in new_comment.replies.all %}<div class="reply"><p class="font-weight-bold">{{ reply.replier }}<span class="text-muted font-weight-normal">{{ reply.created_on }}</span></p>{{ reply.body | linebreaks }}</div>{% endfor %}</div>';
					}
				},
				error: function (request, status, error) {
					console.log(request.responseText);
				}
       });
   });
})
</script>
{% endblock content %}